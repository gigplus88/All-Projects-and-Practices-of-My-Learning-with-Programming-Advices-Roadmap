<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>IndexedDB Cursor Searching Demo</title>

    <style>
      /* ================================
         Global Page Styling (Dark UI)
      ================================ */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: radial-gradient(circle at top, #1f2937, #020617 60%);
        color: #f9fafb;
      }

      .container {
        width: 1100px;
        max-width: 95vw;
        background: #020617;
        border-radius: 20px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 25px 28px 30px;
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 22px;
      }

      .header {
        grid-column: 1 / -1;
        text-align: center;
        margin-bottom: 5px;
      }

      .header h1 {
        margin: 0;
        font-size: 1.9rem;
      }

      .header p {
        margin: 6px 0 0;
        font-size: 0.95rem;
        color: #9ca3af;
      }

      /* Left column (controls, filters, log) */
      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .card-section {
        background: linear-gradient(145deg, #020617, #030712);
        border-radius: 14px;
        padding: 14px 16px 16px;
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      .section-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #e5e7eb;
      }

      .small-note {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 4px;
      }

      label {
        font-size: 0.85rem;
        color: #e5e7eb;
      }

      .input-row {
        display: flex;
        gap: 8px;
        margin-top: 6px;
        align-items: center;
      }

      input[type="text"],
      input[type="number"] {
        flex: 1;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        outline: none;
        background: #020617;
        color: #f9fafb;
        font-size: 0.9rem;
      }

      input::placeholder {
        color: #6b7280;
      }

      input:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
      }

      button {
        padding: 8px 14px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        color: #e5e7eb;
        background: #2563eb;
        transition: background 0.18s ease, transform 0.12s ease,
          box-shadow 0.18s ease;
        box-shadow: 0 3px 10px rgba(37, 99, 235, 0.4);
      }

      button:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 5px 16px rgba(37, 99, 235, 0.6);
      }

      button:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.35);
      }

      .btn-secondary {
        background: #6b7280;
        box-shadow: 0 3px 10px rgba(75, 85, 99, 0.5);
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      /* Log area */
      #log {
        background: #020617;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.8rem;
        padding: 6px 8px;
      }

      .log-line {
        margin: 2px 0;
      }

      .log-ok {
        color: #22c55e;
      }

      .log-error {
        color: #fb7185;
      }

      .log-info {
        color: #e5e7eb;
      }

      /* Right column (tables) */
      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .section-header-inline {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-title {
        font-size: 0.9rem;
        color: #e5e7eb;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.88rem;
        background: #020617;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      thead {
        background: #0f172a;
      }

      th,
      td {
        padding: 7px 9px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        text-align: left;
      }

      th {
        font-weight: 600;
        color: #e5e7eb;
      }

      tbody tr:nth-child(even) {
        background: #020617;
      }

      tbody tr:nth-child(odd) {
        background: #030712;
      }

      .empty-note {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ===========================
           HEADER
      ============================ -->
      <div class="header">
        <h1>IndexedDB ‚Äì Cursor Searching Demo</h1>
        <p>
          Demonstration of
          <strong>cursors, indexes, and range searching</strong>
          in IndexedDB (All operations happen in the browser).
        </p>
      </div>

      <!-- ===========================
           LEFT PANEL
      ============================ -->
      <div class="left-panel">
        <!-- Search by name (index + cursor) -->
        <div class="card-section">
          <div class="section-title">üîç Search by Name (Index + Cursor)</div>
          <label for="searchName">
            Search users by <strong>name</strong> (case-sensitive):
          </label>
          <div class="input-row">
            <input
              id="searchName"
              type="text"
              placeholder='e.g. "Ahmed", "Omar"...'
            />
            <button onclick="searchByName()">Search</button>
          </div>
          <div class="small-note">
            Uses <code>nameIndex</code> and <code>index.openCursor()</code> to
            find <strong>all</strong> users with this exact name.
          </div>
        </div>

        <!-- Search by age > X (store + cursor) -->
        <div class="card-section">
          <div class="section-title">üìà Filter by Age (Age &gt; X)</div>
          <label for="minAge">Show users where age is greater than:</label>
          <div class="input-row">
            <input id="minAge" type="number" placeholder="e.g. 25" min="0" />
            <button onclick="filterByAge()">Filter</button>
          </div>
          <div class="small-note">
            Uses a cursor on the <code>users</code> store and checks
            <code>cursor.value.age &gt; X</code>.
          </div>
        </div>

        <!-- Range search (ID from... to...) -->
        <div class="card-section">
          <div class="section-title">
            üéØ Range Search by ID (Using IDBKeyRange.bound)
          </div>
          <label>Search users whose ID is between:</label>
          <div class="input-row">
            <input
              id="minId"
              type="number"
              placeholder="Min ID (e.g. 3)"
              min="1"
            />
            <input
              id="maxId"
              type="number"
              placeholder="Max ID (e.g. 10)"
              min="1"
            />
          </div>
          <div class="input-row" style="margin-top: 6px">
            <button onclick="searchByIdRange()">Search Range</button>
          </div>
          <div class="small-note">
            Uses <code>IDBKeyRange.bound(min, max)</code> +
            <code>openCursor(range)</code>.
          </div>
        </div>

        <!-- Log -->
        <div class="card-section">
          <div class="section-title">üßæ Log</div>
          <div id="log"></div>
        </div>

        <!-- Search results table -->
        <div class="card-section">
          <div class="section-header-inline">
            <div class="table-title"><p>üîé Search / Filter Results</p></div>
            <!-- NEW: Clear Results Button -->
            <button
              class="btn-secondary"
              style="padding: 5px 10px; font-size: 0.78rem"
              onclick="clearResults()"
            >
              üßπ Clear
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width: 55px">ID</th>
                <th>Name</th>
                <th style="width: 70px">Age</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
          <div id="resultsEmpty" class="empty-note">
            No search yet or no matching records.
          </div>
        </div>
      </div>

      <!-- ===========================
           RIGHT PANEL
      ============================ -->
      <div class="right-panel">
        <!-- All users table -->
        <div class="card-section">
          <div class="section-header-inline">
            <div class="table-title">
              <p>üìã All Users (Loaded via Cursor)</p>
            </div>
            <button
              style="padding: 5px 10px; font-size: 0.78rem"
              class="btn-secondary"
              onclick="renderAllUsers()"
            >
              üîÑ Refresh
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width: 55px">ID</th>
                <th>Name</th>
                <th style="width: 70px">Age</th>
              </tr>
            </thead>
            <tbody id="allUsersBody"></tbody>
          </table>
          <div id="allUsersEmpty" class="empty-note">
            Loading data or no users found...
          </div>
        </div>
      </div>
    </div>

    <script>
      /* ==========================================================
         Utility: Log messages to on-page log box
      ========================================================== */
      function logMessage(message, type = "info") {
        const logBox = document.getElementById("log");

        // Create a new line for each message
        const line = document.createElement("div");
        line.classList.add("log-line");

        // Add color class depending on type
        if (type === "ok") line.classList.add("log-ok");
        else if (type === "error") line.classList.add("log-error");
        else line.classList.add("log-info");

        // Set the message text
        line.textContent = message;

        // Add line to log box
        logBox.appendChild(line);

        // Auto-scroll to bottom
        logBox.scrollTop = logBox.scrollHeight;

        // Also print to console for debugging
        console.log(message);
      }

      /* ==========================================================
         Global DB variable
      ========================================================== */
      let db;

      /* ==========================================================
         Open (or create) IndexedDB database
         - Name: "CursorDemoDB"
         - Version: 1
      ========================================================== */
      const openRequest = indexedDB.open("CursorDemoDB", 1);

      /* ==========================================================
         onupgradeneeded
         - Runs when DB is created or version increases
         - Here we:
           1) Create "users" store
           2) Create indexes
           3) Seed initial data
      ========================================================== */
      openRequest.onupgradeneeded = function (event) {
        // Get database instance
        db = event.target.result;

        // Create object store with keyPath "id"
        const store = db.createObjectStore("users", { keyPath: "id" });

        // Create index by name (not unique ‚Üí multiple same names allowed)
        store.createIndex("nameIndex", "name", { unique: false });

        // Create index by age (not unique as well)
        store.createIndex("ageIndex", "age", { unique: false });

        logMessage("Object store 'users' and indexes created.", "ok");

        // Prepare some sample user data
        const initialUsers = [
          { id: 1, name: "Ahmed", age: 25 },
          { id: 2, name: "Sara", age: 22 },
          { id: 3, name: "Omar", age: 30 },
          { id: 4, name: "Lina", age: 27 },
          { id: 5, name: "Ahmed", age: 35 },
          { id: 6, name: "Hana", age: 24 },
          { id: 7, name: "Khaled", age: 32 },
          { id: 8, name: "Noor", age: 21 },
          { id: 9, name: "Yousef", age: 29 },
          { id: 10, name: "Reem", age: 26 },
          { id: 11, name: "Ali", age: 23 },
          { id: 12, name: "Mona", age: 31 },
          { id: 13, name: "Ahmed", age: 40 },
          { id: 14, name: "Salma", age: 20 },
          { id: 15, name: "Rami", age: 27 },
          { id: 16, name: "Huda", age: 24 },
          { id: 17, name: "Omar", age: 33 },
          { id: 18, name: "Tariq", age: 29 },
          { id: 19, name: "Nour", age: 22 },
          { id: 20, name: "Ahmed", age: 28 },
        ];

        // Use the upgrade transaction to seed initial data
        const upgradeTx = event.target.transaction;
        const upgradeStore = upgradeTx.objectStore("users");

        initialUsers.forEach((user) => {
          upgradeStore.add(user);
        });

        logMessage("20 initial users seeded into 'users' store.", "ok");
      };

      /* ==========================================================
         onsuccess
         - Database successfully opened ‚Üí save reference and render all
      ========================================================== */
      openRequest.onsuccess = function (event) {
        db = event.target.result;
        logMessage("‚úÖ Database opened successfully.", "ok");

        // Load all users into the "All Users" table using a cursor
        renderAllUsers();
      };

      /* ==========================================================
         onerror
      ========================================================== */
      openRequest.onerror = function (event) {
        logMessage("‚ùå Error opening database: " + event.target.error, "error");
      };

      /* ==========================================================
         Helper: Clear search results table
      ========================================================== */
      function clearResults(message = "No search yet or no matching records.") {
        const tbody = document.getElementById("resultsBody");
        tbody.innerHTML = "";

        const emptyNote = document.getElementById("resultsEmpty");
        emptyNote.textContent = message;
      }

      /* ==========================================================
         Render all users using a cursor on the object store
      ========================================================== */
      function renderAllUsers() {
        const tbody = document.getElementById("allUsersBody");
        const emptyNote = document.getElementById("allUsersEmpty");

        // Clear previous content
        tbody.innerHTML = "";
        emptyNote.textContent = "Loading data...";

        // Open a read-only transaction on "users"
        const tx = db.transaction("users", "readonly");
        const store = tx.objectStore("users");

        // Open a cursor to iterate over all records
        const request = store.openCursor();
        let count = 0;

        request.onsuccess = function (event) {
          // Get the cursor from the event result
          const cursor = event.target.result;

          // If cursor is valid ‚Üí process current record
          if (cursor) {
            const user = cursor.value;

            // Create table row
            const tr = document.createElement("tr");

            const tdId = document.createElement("td");
            tdId.textContent = user.id;

            const tdName = document.createElement("td");
            tdName.textContent = user.name;

            const tdAge = document.createElement("td");
            tdAge.textContent = user.age;

            tr.appendChild(tdId);
            tr.appendChild(tdName);
            tr.appendChild(tdAge);

            tbody.appendChild(tr);

            count++;

            // Move cursor to the next record
            cursor.continue();
          } else {
            // No more records
            if (count === 0) {
              emptyNote.textContent = "No users found in database.";
            } else {
              emptyNote.textContent = `Total users: ${count}`;
            }
            logMessage(`üìã All users rendered. Count: ${count}`, "info");
          }
        };

        request.onerror = function () {
          logMessage("‚ùå Error iterating users with cursor.", "error");
          emptyNote.textContent = "Error loading users.";
        };
      }

      /* ==========================================================
         Search by NAME using an index + cursor
         - Case-sensitive exact match
      ========================================================== */
      function searchByName() {
        const nameInput = document.getElementById("searchName");
        const name = nameInput.value.trim();

        // Clear any old results
        clearResults();

        if (name === "") {
          alert("Please enter a name to search.");
          return;
        }

        logMessage(
          `üîç Searching for users with name = "${name}" using cursor on index...`,
          "info"
        );

        const tbody = document.getElementById("resultsBody");
        const emptyNote = document.getElementById("resultsEmpty");

        // Open read-only transaction
        const tx = db.transaction("users", "readonly");
        const store = tx.objectStore("users");

        // Get the index on "name"
        const index = store.index("nameIndex");

        // Open a cursor over the entire index (no key range here)
        const request = index.openCursor();
        let matches = 0;

        request.onsuccess = function (event) {
          const cursor = event.target.result;

          if (cursor) {
            // cursor.key is the indexed field (name)
            if (cursor.key === name) {
              const user = cursor.value;

              const tr = document.createElement("tr");

              const tdId = document.createElement("td");
              tdId.textContent = user.id;

              const tdName = document.createElement("td");
              tdName.textContent = user.name;

              const tdAge = document.createElement("td");
              tdAge.textContent = user.age;

              tr.appendChild(tdId);
              tr.appendChild(tdName);
              tr.appendChild(tdAge);

              tbody.appendChild(tr);
              matches++;
            }

            // Move cursor forward
            cursor.continue();
          } else {
            // Cursor finished scanning
            if (matches === 0) {
              emptyNote.textContent = `No users found with name "${name}".`;
              logMessage(`‚ùå No users found with name "${name}".`, "error");
            } else {
              emptyNote.textContent = `Found ${matches} user(s) named "${name}".`;
              logMessage(
                `‚úÖ Search complete. Found ${matches} user(s) named "${name}".`,
                "ok"
              );
            }
          }
        };

        request.onerror = function () {
          logMessage("‚ùå Error while searching by name using cursor.", "error");
        };
      }

      /* ==========================================================
         Filter by age: show users with age > X using cursor
      ========================================================== */
      function filterByAge() {
        const minAgeInput = document.getElementById("minAge");
        const minAgeValue = minAgeInput.value.trim();

        // Clear previous results
        clearResults();

        if (minAgeValue === "") {
          alert("Please enter a minimum age.");
          return;
        }

        const minAge = Number(minAgeValue);

        if (Number.isNaN(minAge)) {
          alert("Please enter a valid number for age.");
          return;
        }

        logMessage(
          `üìà Filtering users with age > ${minAge} using cursor on store...`,
          "info"
        );

        const tbody = document.getElementById("resultsBody");
        const emptyNote = document.getElementById("resultsEmpty");

        // Open read-only transaction
        const tx = db.transaction("users", "readonly");
        const store = tx.objectStore("users");

        // Open cursor over all records in the store
        const request = store.openCursor();
        let count = 0;

        request.onsuccess = function (event) {
          const cursor = event.target.result;

          if (cursor) {
            const user = cursor.value;

            // Apply condition: age > minAge
            if (user.age > minAge) {
              const tr = document.createElement("tr");

              const tdId = document.createElement("td");
              tdId.textContent = user.id;

              const tdName = document.createElement("td");
              tdName.textContent = user.name;

              const tdAge = document.createElement("td");
              tdAge.textContent = user.age;

              tr.appendChild(tdId);
              tr.appendChild(tdName);
              tr.appendChild(tdAge);

              tbody.appendChild(tr);
              count++;
            }

            // Move to next record
            cursor.continue();
          } else {
            // Done scanning
            if (count === 0) {
              emptyNote.textContent = `No users with age > ${minAge}.`;
              logMessage(`‚ùå No users found with age > ${minAge}.`, "error");
            } else {
              emptyNote.textContent = `Found ${count} user(s) with age > ${minAge}.`;
              logMessage(
                `‚úÖ Filter complete. Found ${count} user(s) with age > ${minAge}.`,
                "ok"
              );
            }
          }
        };

        request.onerror = function () {
          logMessage(
            "‚ùå Error while filtering users by age using cursor.",
            "error"
          );
        };
      }

      /* ==========================================================
         Range search by ID using IDBKeyRange.bound + cursor
      ========================================================== */
      function searchByIdRange() {
        const minIdInput = document.getElementById("minId");
        const maxIdInput = document.getElementById("maxId");

        const minIdValue = minIdInput.value.trim();
        const maxIdValue = maxIdInput.value.trim();

        // Clear previous results
        clearResults();

        if (minIdValue === "" || maxIdValue === "") {
          alert("Please enter both Min ID and Max ID.");
          return;
        }

        const minId = Number(minIdValue);
        const maxId = Number(maxIdValue);

        if (Number.isNaN(minId) || Number.isNaN(maxId)) {
          alert("Please enter valid numbers for ID range.");
          return;
        }

        if (minId > maxId) {
          alert("Min ID cannot be greater than Max ID.");
          return;
        }

        logMessage(
          `üéØ Searching users with ID between ${minId} and ${maxId} (inclusive)...`,
          "info"
        );

        const tbody = document.getElementById("resultsBody");
        const emptyNote = document.getElementById("resultsEmpty");

        // Create IDBKeyRange for the given ID range
        const range = IDBKeyRange.bound(minId, maxId);

        // Open readonly transaction and cursor using the range
        const tx = db.transaction("users", "readonly");
        const store = tx.objectStore("users");

        const request = store.openCursor(range);
        let count = 0;

        request.onsuccess = function (event) {
          const cursor = event.target.result;

          if (cursor) {
            const user = cursor.value;

            const tr = document.createElement("tr");

            const tdId = document.createElement("td");
            tdId.textContent = user.id;

            const tdName = document.createElement("td");
            tdName.textContent = user.name;

            const tdAge = document.createElement("td");
            tdAge.textContent = user.age;

            tr.appendChild(tdId);
            tr.appendChild(tdName);
            tr.appendChild(tdAge);

            tbody.appendChild(tr);
            count++;

            cursor.continue();
          } else {
            // Finished scanning range
            if (count === 0) {
              emptyNote.textContent = `No users found with ID between ${minId} and ${maxId}.`;
              logMessage(
                `‚ùå No users found with ID between ${minId} and ${maxId}.`,
                "error"
              );
            } else {
              emptyNote.textContent = `Found ${count} user(s) with ID between ${minId} and ${maxId}.`;
              logMessage(
                `‚úÖ Range search complete. Found ${count} user(s).`,
                "ok"
              );
            }
          }
        };

        request.onerror = function () {
          logMessage(
            "‚ùå Error while searching ID range using cursor.",
            "error"
          );
        };
      }
    </script>
  </body>
</html>
